stages:
  - build
  - test

build:msvc:
  stage: build
  tags:
    - windows-1809
  before_script:
    - git submodule update --init --recursive
    - choco install -y cmake
    - choco install -y python
    - choco upgrade -y visualstudio2019buildtools
    - $env:Path += ';C:\Program Files\CMake\bin'
  script:
    - mkdir build
    - cd build
    - cmake -DGAR_BUILD_TESTS=ON -G "Visual Studio 16 2019" ..
    - cmake --build . --target ALL_BUILD --config Release
  artifacts:
    paths:
      - build/

build:gcc:
  stage: build
  image: registry.gitlab.com/digital-vessel/garlic-engine/garlic/build_environment/linux:2.0.0
  before_script:
    - git submodule update --init --recursive
  script:
    - mkdir build
    - cd build
    - cmake -DGAR_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=/usr/bin/gcc-10 -DCMAKE_CXX_COMPILER=/usr/bin/g++-10 -G "Unix Makefiles" ..
    - cmake --build .
  artifacts:
    paths:
      - build/

build:clang:
  stage: build
  image: registry.gitlab.com/digital-vessel/garlic-engine/garlic/build_environment/linux:2.0.0
  before_script:
    - git submodule update --init --recursive
  script:
    - mkdir build
    - cd build
    - cmake -DGAR_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=/usr/bin/clang-10 -DCMAKE_CXX_COMPILER=/usr/bin/clang++-10 -G "Unix Makefiles" ..
    - cmake --build .
  artifacts:
    paths:
      - build/

build:scape:windows:
  stage: build
  tags:
    - windows-1809
  before_script:
    - git submodule update --init --recursive
    - choco install -y cmake
    - choco install -y python
    - choco upgrade -y visualstudio2019buildtools
    - $env:Path += ';C:\Program Files\CMake\bin'
  script:
    - cd Scape/Editor
    - dotnet build -c Release

build:scape:linux:
  stage: build
  image: registry.gitlab.com/digital-vessel/garlic-engine/garlic/build_environment/linux:2.0.0
  before_script:
    - git submodule update --init --recursive
  script:
    - cd Scape/Editor
    - dotnet build -c Release

test:msvc:
  stage: test
  tags:
    - windows-1809
  before_script:
    - choco install -y cmake
    - $env:Path += ';C:\Program Files\CMake\bin'
  script:
    - cd build
    - ctest -C Release
  dependencies:
    - build:msvc
  needs:
    - build:msvc

test:gcc:
  stage: test
  image: registry.gitlab.com/digital-vessel/garlic-engine/garlic/build_environment/linux:2.0.0
  script:
    - cd build
    - ctest -C Release
  dependencies:
    - build:gcc
  needs:
    - build:gcc

test:clang:
  stage: test
  image: registry.gitlab.com/digital-vessel/garlic-engine/garlic/build_environment/linux:2.0.0
  script:
    - cd build
    - ctest -C Release
  dependencies:
    - build:clang
  needs:
    - build:clang